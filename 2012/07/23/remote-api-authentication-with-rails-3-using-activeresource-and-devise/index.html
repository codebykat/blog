
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Remote API Authentication With Rails 3 Using ActiveResource and Devise - codebykat.blog</title>
  <meta name="author" content="kat">

  
  <meta name="description" content="I recently had to implement this workflow for a client project, and it got a little confusing. There&rsquo;s a lot of example code floating around, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.codebykat.com/2012/07/23/remote-api-authentication-with-rails-3-using-activeresource-and-devise">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="codebykat.blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26103370-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">codebykat.blog</a></h1>
  
    <h2>thoughts on code, tech and life.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.codebykat.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="http://codebykat.com/">code.by.kat</a></li>
  <li><a href="/">blog</a></li>
  <li><a href="/archive">archive</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Remote API Authentication With Rails 3 Using ActiveResource and Devise</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-23T14:49:00-07:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I recently had to implement this workflow for a client project, and it got a little confusing.  There&rsquo;s a lot of example code floating around, but it took some trial and error to get everything working smoothly.  So, on the off-chance it&rsquo;ll be helpful for someone else, here&rsquo;s a walkthrough that illustrates the complete package.</p>

<!--more-->


<p>Caveat: ActiveResource <a href="http://news.ycombinator.com/item?id=3818223">has been removed from Rails core</a>, and I hear there may be better solutions out there for interacting with remote APIs.  At the outset of this project it seemed like the best way to quickly get things working, but your mileage may vary.</p>

<h3>Contents</h3>

<p><a href="#part0">Part 0: The Big Picture</a><br />
<a href="#backend">Part 1: The Backend</a><br />
<a href="#frontend">Part 2: The Front End</a><br />
<a href="#part3">Part 3: The Fiddly Bits</a></p>

<h2><a id='part0'>Part 0: The Big Picture</a></h2>

<p>The basic architecture consists of two Rails sites:</p>

<p><strong>The Backend:</strong> A pure JSON API that authenticates users via Devise&rsquo;s token_authenticatable module.  Uses ActiveRecord database models, no session storage.</p>

<p><strong>The Front End:</strong> A client that signs users in by requesting and storing a token from the backend.  Uses session storage and ActiveResource models.</p>

<p>I&rsquo;ll talk about the configuration for each of these separately, and then some of the integration work (read: hacking) I had to do to get everything running smoothly.</p>

<p><strong>Security Warning!</strong> This setup is <strong>completely insecure</strong> if used over HTTP (since email/password are sent in plaintext).  You definitely want to ensure that your front end communicates with your backend strictly via HTTPS in order to protect against man-in-the-middle attacks.</p>

<h2><a id='backend'>Part 1: The Backend</a></h2>

<h3>1. Install Devise</h3>

<p>This is covered well elsewhere so I won’t get into it.  Add ‘devise’ to your gemfile and check out the Devise <a href="https://github.com/plataformatec/devise#getting-started">documentation</a> for basic setup.  <a href="http://railscasts.com/episodes/209-introducing-devise?view=asciicast">RailsCasts</a> are also a great resource for this.</p>

<h3>2. Configure Devise to use :token_authenticatable</h3>

<p>The <a href="http://rdoc.info/github/plataformatec/devise/master/Devise/Models/TokenAuthenticatable">token_authenticatable</a> module adds authentication tokens to a model and sets it up so Devise can use them to log users in.</p>

<p>First, we need a new database column.  Older versions of Devise had the t.token_authenticatable shorthand for this, but that is now deprecated, so we need to set up the column and index manually.</p>

<p>Create a new database migration:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddTokensToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>      <span class="n">change_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>          <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:authentication_token</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:authentication_token</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tell Devise to use tokens for the User model by adding :token_authenticatable to the devise line in your model, e.g.:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">devise</span> <span class="ss">:database_authenticatable</span><span class="p">,</span> <span class="ss">:registerable</span><span class="p">,</span> <span class="ss">:token_authenticatable</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:recoverable</span><span class="p">,</span> <span class="ss">:rememberable</span><span class="p">,</span> <span class="ss">:trackable</span><span class="p">,</span> <span class="ss">:validatable</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then a few small changes to the Devise config (config/initializers/devise.rb):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">skip_session_storage</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:http_auth</span><span class="p">,</span> <span class="ss">:token_auth</span><span class="o">]</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">token_authentication_key</span> <span class="o">=</span> <span class="ss">:auth_token</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line tells Devise not to store the user in the session.</p>

<p>The second line changes what you’re going to call your authentication token parameter &mdash; I changed mine to &ldquo;auth_token&rdquo; because I didn&rsquo;t want to be typing &ldquo;authentication_token&rdquo; all the time, but you can call it whatever you want (or leave it as the default).</p>

<p>Now any protected content needs to be wrapped with a filter that tells it to deny access if the user is not authenticated.  In my Users controller, I added:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before_filter</span> <span class="ss">:authenticate_user!</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">:show</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now we have all the infrastructure in place.  Next, we need a way to actually authenticate the user.  That&rsquo;s the job of the Sessions controller, which checks a given username and password and, if they&rsquo;re valid, returns a token (as well as the ID of the user in question).  Note that, since there’s no session-based sign-in on the backend, we never call Devise&rsquo;s sign_in/sign_out methods.  We&rsquo;re just validating the password, making sure the user has an auth token generated, and returning it.</p>

<p>(In some sense, a user is &ldquo;signed in&rdquo; to the backend as long as they have a valid authentication token.  If you want, you can expire this token after some period of time instead of having it stick around indefinitely.  You could also reset it after a certain number of uses.)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">SessionsController</span><span class="p">:</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>      <span class="n">build_resource</span>
</span><span class='line'>      <span class="n">resource</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_for_database_authentication</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">invalid_login_attempt</span> <span class="k">unless</span> <span class="n">resource</span>
</span><span class='line'>          
</span><span class='line'>      <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">valid_password?</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>          <span class="n">resource</span><span class="o">.</span><span class="n">ensure_authentication_token!</span>  <span class="c1">#make sure the user has a token generated</span>
</span><span class='line'>          <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:authentication_token</span> <span class="o">=&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">authentication_token</span><span class="p">,</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">id</span> <span class="p">},</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="ss">:created</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>  <span class="c1"># expire auth token</span>
</span><span class='line'>  <span class="vi">@user</span><span class="o">=</span><span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:authentication_token</span><span class="o">=&gt;</span><span class="n">params</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>  <span class="vi">@user</span><span class="o">.</span><span class="n">reset_authentication_token!</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:message</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;Session deleted.&quot;</span><span class="o">]</span> <span class="p">},</span>  <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="ss">:ok</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>  
</span><span class='line'><span class="k">def</span> <span class="nf">invalid_login_attempt</span>
</span><span class='line'>  <span class="n">warden</span><span class="o">.</span><span class="n">custom_failure!</span>
</span><span class='line'>  <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:errors</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;Invalid email or password.&quot;</span><span class="o">]</span> <span class="p">},</span>  <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="ss">:unauthorized</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>On login, we call @user.ensure_authentication_token! to make sure the user has a token saved.  You could also add this call to your User#create method to generate the token when the user is first created.</p>

<p>When the session is destroyed, we call @user.reset_authentication_token! to expire the current token and generate a new one.</p>

<p>The last piece of the puzzle is making sure you have sign_in and sign_out routes.  This should actually be a given if you have Devise set up correctly, but just to cover all the bases, a simple devise_for call in config/routes.rb will route /users/sign_in and /users/sign_out to the right places:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">devise_for</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:controllers</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:sessions</span> <span class="o">=&gt;</span> <span class="s2">&quot;sessions&quot;</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>rake routes
</span><span class='line'>user_session          POST    /users/sign_in<span class="o">(</span>.:format<span class="o">)</span>  sessions#create
</span><span class='line'>destroy_user_session  DELETE  /users/sign_out<span class="o">(</span>.:format<span class="o">)</span> sessions#destroy
</span></code></pre></td></tr></table></div></figure>


<p>Now you should be able to test the backend via curl or an app like <a href="http://ditchnet.org/httpclient/">HTTPClient</a>.  Here&rsquo;s a quick cheat sheet to test that everything&rsquo;s working properly.  This assumes you&rsquo;ve already created a user on the backend.  Obviously, replace &ldquo;localhost:3000&rdquo; with your test URL.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>curl http://localhost:3000/users/sign_in --data <span class="s2">&quot;email=me@example.com&amp;password=secret&quot;</span>
</span><span class='line'><span class="c"># should return the token and user ID.</span>
</span><span class='line'>
</span><span class='line'>curl http://localhost:3000/a_protected_page
</span><span class='line'><span class="c"># no token - should return 401 Unauthorized.</span>
</span><span class='line'>
</span><span class='line'>curl http://localhost:3000/a_protected_page&amp;auth_token<span class="o">={</span>token<span class="o">}</span>
</span><span class='line'><span class="c"># should return the requested information.</span>
</span><span class='line'>
</span><span class='line'>curl -x DELETE http://localhost:3000/users/sign_out&amp;auth_token<span class="o">={</span>token<span class="o">}</span>
</span><span class='line'><span class="c"># should log out the user, changing the authentication token.</span>
</span></code></pre></td></tr></table></div></figure>


<p>All good?  Now we just have to set it up so the front end knows how to play this game.</p>

<h2><a id='frontend'>Part 2: The Front End</a></h2>

<p>The front end does not have Devise installed.  We don’t need it, because the user and session models are so simple, almost stubs.  All they do is add a layer of abstraction to the API calls.  You could probably still use Devise to manage your sessions and templates, but since I&rsquo;m using custom sign in and registration templates, it felt like overkill.</p>

<p>The user model on the front end is just an ActiveResource model whose site points to the backend URL.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveResource</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:3000&quot;</span>  <span class="c1"># your backend URL here</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have another custom Sessions Controller on the front end which is responsible for managing login and logout.  It sends the provided email and password to the backend and saves the returned token and user ID in the session cookie.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>      <span class="c1"># uses ActiveResource custom REST method</span>
</span><span class='line'>      <span class="c1"># POST to @user.site/users/sign_in with params email/password and receive a token in return</span>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="ss">:sign_in</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;201&quot;</span>
</span><span class='line'>          <span class="n">response_body</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>          <span class="n">session</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">response_body</span><span class="o">[</span><span class="s2">&quot;authentication_token&quot;</span><span class="o">]</span>
</span><span class='line'>          <span class="n">session</span><span class="o">[</span><span class="ss">:current_user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">response_body</span><span class="o">[</span><span class="s2">&quot;user_id&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="c1"># handle errors gracefully</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="ow">and</span> <span class="k">return</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>      <span class="c1"># DELETE to @user.site/users/sign_out</span>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:sign_out</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># TODO might want to check response to make sure it worked..</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># clean up our session and instance variables</span>
</span><span class='line'>      <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:auth_token</span><span class="p">)</span>
</span><span class='line'>      <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:current_user_id</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@current_user</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="ow">and</span> <span class="k">return</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Oh, know what else would be nice?  A helper method to see if we’re logged in and get the current user, similar to the one Devise provides.  This goes in the Application controller:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">helper_method</span> <span class="ss">:current_user</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">current_user</span>
</span><span class='line'>          <span class="vi">@_current_user</span> <span class="o">||=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:current_user_id</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:current_user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, cool, now you can refer to current_user from templates just like in Devise.</p>

<h2><a id='part3'>Part 3. The Fiddly Bits</a></h2>

<p>There&rsquo;s only one piece missing: appending the stored authentication token to every backend API call.  I didn&rsquo;t expect this to be the hard part, but&hellip; now it gets complicated.</p>

<p>Basically, ActiveResource doesn’t support this use case.  You can set an extra parameter on the object, but then ActiveResource will pass it wrapped up as part of the object, not on its own, which will break the Devise magic on the backend.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@user</span><span class="o">.</span><span class="n">auth_token</span> <span class="o">=</span> <span class="n">token</span>
</span><span class='line'><span class="c1"># the backend gets {:user =&gt; {:email =&gt; &quot;me@example.com&quot;, ... :auth_token =&gt; token}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some ActiveResource methods <em>do</em> support passing extra parameters, but you can&rsquo;t do it for every method, the format is inconsistent (and apparently undocumented), and we don&rsquo;t want to type all that out all the time anyway&hellip;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;</span> <span class="no">User</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:sign_out</span><span class="p">,</span> <span class="ss">:auth_token</span> <span class="o">=&gt;</span> <span class="n">session</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="c1"># that works, but...</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="no">Group</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:first</span><span class="p">,</span> <span class="ss">:params</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:auth_token</span> <span class="o">=&gt;</span> <span class="n">session</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="c1"># hmm... that works too, but the format is different...</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;edited name&quot;</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">g</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'><span class="ss">ActiveResource</span><span class="p">:</span><span class="ss">:UnauthorizedAccess</span><span class="p">:</span> <span class="no">Failed</span><span class="o">.</span>  <span class="no">Response</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">401</span><span class="o">.</span>  <span class="no">Response</span> <span class="n">message</span> <span class="o">=</span> <span class="no">Unauthorized</span> <span class="o">.</span>
</span><span class='line'><span class="c1"># whoops... what about...</span>
</span><span class='line'><span class="o">&gt;</span> <span class="no">Group</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:3030?auth_token=&quot;</span> <span class="o">.</span> <span class="n">session</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">]</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">g</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'><span class="ss">ActiveResource</span><span class="p">:</span><span class="ss">:UnauthorizedAccess</span><span class="p">:</span> <span class="no">Failed</span><span class="o">.</span>  <span class="no">Response</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">401</span><span class="o">.</span>  <span class="no">Response</span> <span class="n">message</span> <span class="o">=</span> <span class="no">Unauthorized</span> <span class="o">.</span>
</span><span class='line'><span class="c1"># OK, this is getting ugly...</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">g</span><span class="o">.</span><span class="n">save!</span><span class="p">(</span><span class="ss">:auth_token</span> <span class="o">=&gt;</span> <span class="s2">&quot;wh5xeZpwf6zHG9aHzy6M&quot;</span><span class="p">)</span>
</span><span class='line'><span class="ss">ArgumentError</span><span class="p">:</span> <span class="n">wrong</span> <span class="n">number</span> <span class="n">of</span> <span class="n">arguments</span> <span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="c1"># fine then!</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">g</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</span><span class='line'><span class="ss">URI</span><span class="p">:</span><span class="ss">:InvalidURIError</span><span class="p">:</span> <span class="n">bad</span> <span class="no">URI</span><span class="p">(</span><span class="n">is</span> <span class="ow">not</span> <span class="no">URI</span><span class="sc">?)</span><span class="p">:</span> <span class="sr">/groups/</span><span class="mi">1</span><span class="o">/</span><span class="c1">#&lt;Group:0x007fe0d4998880&gt;.json</span>
</span><span class='line'><span class="c1">#  (╯°□°）╯︵ ┻━┻) </span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, look, forget it.  What we <em>really</em> want is a way to automatically send the authentication token, if we have it, with every single request &mdash; in a way that works transparently with ActiveResource, so it won&rsquo;t matter if we&rsquo;re doing a find, update, or delete.</p>

<p>As it happens, you can overload ActiveResource&rsquo;s basic HTTP authentication functionality to add the token to the headers on every request.  The catch is that we then have to add some more backend code, to pull the token out of the header and treat it like an ordinary param.</p>

<p>Clear as mud?  Let&rsquo;s look at the code.</p>

<p>First, the front end.</p>

<p>ActiveResource supports HTTP digest authentication: if you set a user and password on the ActiveResource object, they will get passed with every request, just like we want (albeit as a header, not a parameter).  But we don&rsquo;t want to set the <em>same</em> token for the entire class (since each user will have their own token), so instead of putting it in the model, we&rsquo;ll have to add a filter to set it each time.</p>

<p>First, add the following function to the &ldquo;protected&rdquo; section of the Application controller:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">set_auth_token</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, add a filter near the top, so we call this function for every request:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before_filter</span> <span class="ss">:set_auth_token</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you examine the request sent to the backend, you&rsquo;ll see that it now contains a &ldquo;HTTP-AUTHORIZATION&rdquo; header.  So far, so good.</p>

<p>Side note: If you have multiple ActiveResource models interacting with the backend, you will have to set the user on each one.   For example: &ldquo;Group.user = session[:auth_token]&rdquo;.  The &ldquo;user&rdquo; (i.e., token) will then be sent for every Group request, such as Group.find, @group.save, etc.</p>

<p>Now ActiveResource is sending the auth_token in the header, but the backend is expecting to find it as a GET or POST parameter.  So we need a little hack on the backend to fish it out, thus allowing Devise to continue transparently handling authentication.</p>

<p>To the backend code!</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">prepend_before_filter</span> <span class="ss">:get_auth_token</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">get_auth_token</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">auth_token</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">].</span><span class="n">blank?</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s2">&quot;HTTP_AUTHORIZATION&quot;</span><span class="o">]</span>
</span><span class='line'>              <span class="c1"># we&#39;re overloading ActiveResource&#39;s Basic HTTP authentication here, so we need to</span>
</span><span class='line'>              <span class="c1"># do some unpacking of the auth token and re-save it as a parameter.</span>
</span><span class='line'>              <span class="n">params</span><span class="o">[</span><span class="ss">:auth_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">auth_token</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">chop</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yeah, ActiveResource is also encrypting that token, and then sending it in the HTTP digest format &ldquo;user:password&rdquo;.  Since we didn&rsquo;t set the password and used our auth_token as the user string, we&rsquo;re looking at &ldquo;encryptedtoken:&rdquo; instead.</p>

<p>So we throw a little string manipulation dance party: split/last/unpack/first/chop, swing your partner, do-si-do!  This unencrypts the token, chops the colon off the end, and adds it to the params for every request so Devise can validate it.</p>

<p>So that&rsquo;s it &mdash; feels like a bit of a hack, but seems to work pretty well in practice.  Has anyone else implemented a system like this?  I&rsquo;d love to hear how you did it!</p>

<h2>Resources</h2>

<h4>Documentation</h4>

<ul>
<li><a href="http://api.rubyonrails.org/classes/ActiveResource/Base.html">ActiveResource documentation</a></li>
<li><a href="http://ofps.oreilly.com/titles/9780596521424/activeresource_id59243.html">Rails 3 In A Nutshell: ActiveResource</a></li>
<li><a href="https://github.com/plataformatec/devise/wiki">Devise wiki</a></li>
</ul>


<h4>Helpful examples</h4>

<p>Mad props to the following lovely folks who shared their code.  It was not always exactly what I needed, but it was a great help in figuring out how to tackle this problem.</p>

<ul>
<li><a href="https://github.com/plataformatec/devise/wiki/How-To:-Simple-Token-Authentication-Example">Two great examples on the Devise wiki</a></li>
<li><a href="http://jessewolgamott.com/blog/2012/01/19/the-one-with-a-json-api-login-using-devise/">Jesse Wolgamott: The One With A JSON API Login Using Devise</a></li>
<li><a href="http://www.justinbritten.com/work/2009/05/rails-api-authentication-using-restful-authentication/">Justin Britten.com: Rails API Authentication Using restful-authentication</a></li>
<li><a href="http://www.eribium.org/blog/?p=77">eribium: RESTful Authentication</a></li>
</ul>


<h4>Alternate Solutions</h4>

<p>Stuff that didn&rsquo;t work for me, but might work for you.</p>

<ul>
<li><a href="http://blog.shuntyard.co.za/2011/10/adding-custom-authentication-strategy.html">Using a custom Warden authentication strategy</a></li>
<li><a href="http://www.railsatwork.com/2010/10/implementing-devise-extensions.html">Extending Devise</a></li>
<li><a href="https://github.com/intridea/omniauth/wiki/List-of-Strategies">Using OmniAuth with the Identity strategy</a></li>
<li><a href="http://stackoverflow.com/questions/6046705/add-api-key-on-every-request-with-rack-middleware">Add an API key to every request using Rack middleware</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">kat</span></span>

      








  


<time datetime="2012-07-23T14:49:00-07:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/categories/rails/'>Rails</a>, <a class='category' href='/categories/ruby/'>Ruby</a>, <a class='category' href='/categories/code/'>code</a>, <a class='category' href='/categories/walkthroughs/'>walkthroughs</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.codebykat.com/2012/07/23/remote-api-authentication-with-rails-3-using-activeresource-and-devise/" data-via="" data-counturl="http://blog.codebykat.com/2012/07/23/remote-api-authentication-with-rails-3-using-activeresource-and-devise/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/10/03/rubyconf-recap/" title="Previous Post: RubyConf Recap">&laquo; RubyConf Recap</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/07/23/remote-api-authentication-with-rails-3-using-activeresource-and-devise/">Remote API Authentication With Rails 3 Using ActiveResource and Devise</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/03/rubyconf-recap/">RubyConf Recap</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/01/hello/">Hello</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/codebykat">@codebykat</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'codebykat',
            count: 5,
            skip_forks: true,
            hide_blog_repo: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Bookmarks</h1>
  <ul id="pinboard_linkroll">Fetching bookmarks...</ul>
  <p><a href="http://pinboard.in/u:wirehead/t:blog">see more &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "wirehead"; //id target for pinboard list
  var pinboard_count = 5; //id target for pinboard list
  var pinboard_tag = "blog"; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - kat -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codebykat';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.codebykat.com/2012/07/23/remote-api-authentication-with-rails-3-using-activeresource-and-devise/';
        var disqus_url = 'http://blog.codebykat.com/2012/07/23/remote-api-authentication-with-rails-3-using-activeresource-and-devise/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
